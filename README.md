# route53-lambda-backup
An AWS Lambda function to automatically back up Route 53 DNS records to S3.

## Nighly scheduled Route53 Backups to S3 bucket CloudWatch Event scheduled via cron 
[Link To Route53 DNS Backups Nightly Run](https://us-west-2.console.aws.amazon.com/cloudwatch/home?region=us-west-2#rules:name=Nightly-Run-Once)
```
Schedule expression: cron(0 09 * * ? *)
```

## AWS Lambda Web API
[Link To MyCompany Ops AWS Login](https://us-west-2.console.aws.amazon.com/lambda/home?region=us-west-2#/functions/route53-lambda-backup)

## Mycompany S3 Bucket Location: mycompany-route53-zonefile-backup 
Example command-line query
```
aws s3 ls --summarize --human-readable --recursive s3://mycompany-route53-zonefile-backups | grep 2019-01-05
2019-01-04 16:36:34  476 Bytes 2019-01-05T00:36:30Z/0.1.10.in-addr.arpa/0.1.10.in-addr.arpa.csv
2019-01-04 16:36:34  934 Bytes 2019-01-05T00:36:30Z/0.1.10.in-addr.arpa/0.1.10.in-addr.arpa.json
2019-01-04 16:36:35  475 Bytes 2019-01-05T00:36:30Z/0.31.172.in-addr.arpa/0.31.172.in-addr.arpa.csv
2019-01-04 16:36:35  927 Bytes 2019-01-05T00:36:30Z/0.31.172.in-addr.arpa/0.31.172.in-addr.arpa.json
...
```

## Setup
This script can be run either as a scheduled AWS Lambda function or as a cron job. Simply upload the script to AWS Lambda, set the `s3_bucket_name` and `s3_bucket_region` environmental variables, set up an IAM role (with Route 53 read-only and S3 read-write permissions), and set a schedule.
Alternatively, you can set the script to run using cron on an EC2 instance with the appropriate IAM role permissions. Don't forget to add the proper Python 3 shebang and set the `s3_bucket_name` and `s3_bucket_region` variables in the file when doing so.

## Requisite IAM Role for Lambda Function
```
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Action": ["s3:ListBucket"],
            "Resource": ["arn:aws:s3:::mycompany-route53-zonefile-backups"]
        },
        {
            "Effect": "Allow",
            "Action": [
                "s3:PutObject",
                "s3:GetObject"
            ],
            "Resource": ["arn:aws:s3:::mycompany-route53-zonefile-backups/*"]
        },
        {
            "Effect":"Allow",
            "Action":[
                "route53:GetHostedZone",
                "route53:ListResourceRecordSets",
                "route53:ListHostedZones",
                "route53:ListHostedZonesByName"
            ],
            "Resource":"*"
        }
    ]
}
```

## Restoring Backups
Backups generated by this script are uploaded as csv and json files to the specified AWS S3 bucket. They can be restored using AWS provided tools, including the AWS CLI, or using the route53-transfer module. The code and documentation for this module, including how to restore the Route 53 DNS record csv backups, can be found [here](https://github.com/RisingOak/route53-transfer).
